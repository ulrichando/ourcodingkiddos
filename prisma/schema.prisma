generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL")
}

model User {
  id                     String                   @id @default(cuid())
  name                   String?
  email                  String                   @unique
  emailVerified          DateTime?
  hashedPassword         String?
  image                  String?
  role                   Role                     @default(STUDENT)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  classReminders         Boolean                  @default(true)
  emailUpdates           Boolean                  @default(false)
  progressReports        Boolean                  @default(true)
  stripeCustomerId       String?                  @unique
  lastSeen               DateTime?
  accounts               Account[]
  achievements           Achievement[]
  bookingsAsInstructor   Booking[]                @relation("BookingInstructor")
  bookingsAsStudent      Booking[]                @relation("BookingStudent")
  classSessions          ClassSession[]           @relation("ClassSessionInstructor")
  enrollments            Enrollment[]
  instructorAvailability InstructorAvailability[] @relation("InstructorAvailabilityInstructor")
  parentProfile          ParentProfile?
  payments               Payment[]
  portfolio              PortfolioItem[]
  sessions               Session[]
  studentProfile         StudentProfile?
  badges                 UserBadge[]
  subscriptions          Subscription[]
}

// Legacy Subscription model (matches existing DB structure)
model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  status               SubscriptionStatus
  priceId              String
  stripeCustomerId     String?
  stripeSubscriptionId String             @unique
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  trialEndsAt          DateTime?
  planType             PlanType?
  maxStudents          Int?
  priceCents           Int?
  startDate            DateTime?
  endDate              DateTime?
  parentEmail          String?
  features             Json?
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  CANCELED
  PAST_DUE
  TRIALING
  PAUSED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum PlanType {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
  FREE_TRIAL
  MONTHLY
  ANNUAL
  FAMILY
}

model StudentProfile {
  id                    String              @id @default(cuid())
  userId                String              @unique
  dob                   DateTime?
  guardianId            String?
  parentEmail           String?
  name                  String?
  avatar                String?
  age                   Int?
  ageGroup              AgeGroup?
  totalXp               Int                 @default(0)
  currentLevel          Int                 @default(1)
  streakDays            Int                 @default(0)
  lastActiveDate        DateTime?
  badges                Json?
  themePreference       ThemePreference?
  accessibilitySettings Json?
  archivedAt            DateTime?
  projects              Project[]           @relation("StudentProjects")
  guardian              ParentProfile?      @relation("ParentGuardian", fields: [guardianId], references: [id])
  user                  User                @relation(fields: [userId], references: [id])
  programEnrollments    ProgramEnrollment[] // programs the student is enrolled in
  studentProjects       StudentProject[]    // showcase projects
}

model ParentProfile {
  id       String           @id @default(cuid())
  userId   String           @unique
  phone    String?
  address  String?
  user     User             @relation(fields: [userId], references: [id])
  children StudentProfile[] @relation("ParentGuardian")
}

model Course {
  id             String          @id @default(cuid())
  title          String
  slug           String          @unique
  description    String
  language       Language
  level          CourseLevel
  ageGroup       AgeGroup
  thumbnailUrl   String?
  totalXp        Int?
  estimatedHours Int?
  isPublished    Boolean         @default(false)
  orderIndex     Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  bookings       Booking[]
  enrollments    Enrollment[]
  lessons        Lesson[]
  programs       ProgramCourse[] // programs that include this course
}

model Lesson {
  id                   String     @id @default(cuid())
  courseId             String
  title                String
  slug                 String
  description          String?
  content              String?
  videoUrl             String?
  exampleCode          String?
  exerciseInstructions String?
  exerciseStarterCode  String?
  exerciseSolution     String?
  xpReward             Int?
  orderIndex           Int?
  isPublished          Boolean    @default(false)
  course               Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress             Progress[]
  project              Project?
  quiz                 Quiz?

  @@unique([courseId, slug])
}

model Quiz {
  id        String     @id @default(cuid())
  lessonId  String     @unique
  questions Question[]
  lesson    Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model Question {
  id            String       @id @default(cuid())
  quizId        String
  question      String
  questionType  QuestionType
  options       Json?
  correctAnswer String
  explanation   String?
  xpReward      Int?
  orderIndex    Int?
  answers       Answer[]
  quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model Answer {
  id          String   @id @default(cuid())
  questionId  String
  text        String
  isCorrect   Boolean  @default(false)
  explanation String?
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Enrollment {
  id           String           @id @default(cuid())
  userId       String
  courseId     String
  status       EnrollmentStatus @default(ACTIVE)
  startedAt    DateTime         @default(now())
  completedAt  DateTime?
  certificates Certificate[]
  course       Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id])
  progress     Progress[]

  @@unique([userId, courseId])
}

model Certificate {
  id               String     @id @default(cuid())
  enrollmentId     String
  issuedAt         DateTime   @default(now())
  url              String
  studentName      String?
  courseTitle      String?
  achievementType  String?
  verificationCode String?
  studentId        String?
  courseId         String?
  enrollment       Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
}

model Progress {
  id               String         @id @default(cuid())
  enrollmentId     String
  lessonId         String
  status           ProgressStatus @default(NOT_STARTED)
  score            Int?
  completedAt      DateTime?
  xpEarned         Int?
  quizScore        Int?
  timeSpentMinutes Int?
  codeSubmission   String?
  enrollment       Enrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson           Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
}

model Booking {
  id                 String        @id @default(cuid())
  studentId          String
  instructorId       String
  courseId           String?
  startsAt           DateTime
  endsAt             DateTime
  type               BookingType
  status             BookingStatus @default(SCHEDULED)
  notes              String?
  sessionId          String?
  parentEmail        String?
  attended           Boolean       @default(false)
  instructorNotes    String?
  cancelledAt        DateTime?
  cancellationReason String?
  course             Course?       @relation(fields: [courseId], references: [id])
  instructor         User          @relation("BookingInstructor", fields: [instructorId], references: [id])
  session            ClassSession? @relation(fields: [sessionId], references: [id])
  student            User          @relation("BookingStudent", fields: [studentId], references: [id])
  schedule           Schedule?

  @@index([studentId])
  @@index([instructorId])
  @@index([sessionId])
}

model Schedule {
  id         String  @id @default(cuid())
  bookingId  String  @unique
  timezone   String
  recurrence Json?
  reminders  Json?
  booking    Booking @relation(fields: [bookingId], references: [id])
}

model ClassSession {
  id                String             @id @default(cuid())
  instructorId      String?
  instructorEmail   String
  programId         String?            // Link to Program for consistency
  title             String
  description       String?
  sessionType       SessionType
  language          Language
  ageGroup          AgeGroup
  startTime         DateTime
  durationMinutes   Int
  maxStudents       Int?
  enrolledCount     Int?               @default(0)
  priceCents        Int?               @default(0)
  meetingUrl        String?
  status            SessionStatus      @default(SCHEDULED)
  isRecurring       Boolean            @default(false)
  recurrencePattern RecurrencePattern?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  bookings          Booking[]
  instructor        User?              @relation("ClassSessionInstructor", fields: [instructorId], references: [id])
  program           Program?           @relation(fields: [programId], references: [id])

  @@index([instructorId])
  @@index([startTime])
  @@index([programId])
}

model InstructorAvailability {
  id              String    @id @default(cuid())
  instructorId    String?
  instructorEmail String?
  dayOfWeek       Int?
  startTime       String
  endTime         String
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  isRecurring     Boolean   @default(true)
  specificDate    DateTime?
  instructor      User?     @relation("InstructorAvailabilityInstructor", fields: [instructorId], references: [id])

  @@index([instructorId])
  @@index([dayOfWeek])
  @@index([specificDate])
}

model Payment {
  id                    String        @id @default(cuid())
  userId                String
  amount                Int
  currency              String        @default("usd")
  status                PaymentStatus
  stripePaymentIntentId String        @unique
  stripeCustomerId      String?
  createdAt             DateTime      @default(now())
  user                  User          @relation(fields: [userId], references: [id])
}

model Badge {
  id               String           @id @default(cuid())
  key              String           @unique
  name             String
  description      String
  icon             String?
  category         BadgeCategory?
  requirementType  RequirementType?
  requirementValue Int?
  rarity           BadgeRarity?
  criteria         Json?
  users            UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, badgeId])
}

model Conversation {
  id            String                    @id @default(cuid())
  title         String?
  type          String                    @default("direct")
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  lastMessageAt DateTime?
  participants  ConversationParticipant[]
  messages      Message[]
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userEmail      String
  userRole       Role
  userName       String?
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userEmail])
  @@index([userEmail])
}

model Message {
  id             String       @id @default(cuid())
  fromEmail      String
  content        String
  isRead         Boolean      @default(false)
  messageType    MessageType  @default(GENERAL)
  createdAt      DateTime     @default(now())
  attachmentName String?
  attachmentUrl  String?
  conversationId String
  fromName       String?
  fromRole       Role
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([fromEmail])
}

model SupportTicket {
  id              String         @id @default(cuid())
  ticketNumber    String         @unique
  userEmail       String
  userRole        Role
  userName        String?
  subject         String
  description     String
  category        TicketCategory @default(GENERAL)
  priority        TicketPriority @default(MEDIUM)
  status          TicketStatus   @default(OPEN)
  assignedToEmail String?
  assignedToName  String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  resolvedAt      DateTime?
  closedAt        DateTime?
  replies         TicketReply[]

  @@index([userEmail])
  @@index([status])
  @@index([assignedToEmail])
}

model TicketReply {
  id             String        @id @default(cuid())
  ticketId       String
  fromEmail      String
  fromRole       Role
  fromName       String?
  message        String
  attachmentName String?
  attachmentUrl  String?
  isInternal     Boolean       @default(false)
  createdAt      DateTime      @default(now())
  ticket         SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model ClassRequest {
  id                      String             @id @default(cuid())
  parentEmail             String
  parentName              String?
  studentId               String?
  studentName             String?
  studentAge              Int?
  requestedTopic          String
  description             String?
  preferredDays           Json?
  preferredTimes          Json?
  duration                Int?
  status                  ClassRequestStatus @default(PENDING)
  instructorEmail         String?
  instructorName          String?
  scheduledDate           DateTime?
  scheduledTime           String?
  bookingId               String?
  adminNotes              String?
  parentNotes             String?
  rejectionReason         String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  reviewedAt              DateTime?
  scheduledAt             DateTime?
  discountApplied         Int?
  numberOfSessions        Int?
  paidAt                  DateTime?
  paymentStatus           String?            @default("UNPAID")
  pricePerSession         Int?
  stripePaymentId         String?
  totalPrice              Int?
  daysPerWeek             Int?
  numberOfWeeks           Int?
  preferredInstructorId   String?
  preferredInstructorName String?

  @@index([parentEmail])
  @@index([status])
  @@index([instructorEmail])
  @@index([paymentStatus])
}

model Achievement {
  id        String   @id @default(cuid())
  userId    String
  title     String
  detail    String?
  icon      String?
  xpAwarded Int      @default(0)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Project {
  id           String          @id @default(cuid())
  lessonId     String          @unique
  studentId    String?
  title        String
  brief        String
  rubric       Json?
  language     Language?
  code         String?
  thumbnailUrl String?
  isPublic     Boolean         @default(false)
  isFeatured   Boolean         @default(false)
  shareToken   String?         @unique
  submissions  PortfolioItem[]
  lesson       Lesson          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student      StudentProfile? @relation("StudentProjects", fields: [studentId], references: [id])

  @@index([studentId])
}

model PortfolioItem {
  id          String   @id @default(cuid())
  userId      String
  projectId   String
  title       String
  description String?
  repoUrl     String?
  demoUrl     String?
  assets      Json?
  score       Int?
  feedback    String?
  submittedAt DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, projectId])
}

/// NextAuth models for email (magic link) sign-in and OAuth account storage
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PlatformSettings {
  id                       String    @id @default("default")
  siteName                 String    @default("Our Coding Kiddos")
  maintenanceMode          Boolean   @default(false)
  maintenanceMessage       String?   // Custom maintenance message
  maintenanceEndTime       DateTime? // Scheduled maintenance end time for countdown
  allowRegistration        Boolean   @default(true)
  requireEmailVerification Boolean   @default(false)
  defaultXpPerLesson       Int       @default(50)
  xpPerLevel               Int       @default(500)
  maxStudentsPerParent     Int       @default(5)
  sessionDurationMinutes   Int       @default(60)
  enableNotifications      Boolean   @default(true)
  enableMessaging          Boolean   @default(true)
  enableCertificates       Boolean   @default(true)
  enableBadges             Boolean   @default(true)
  stripeEnabled            Boolean   @default(false)
  demoMode                 Boolean   @default(false)
  updatedAt                DateTime  @updatedAt
  createdAt                DateTime  @default(now())
}

model AuditLog {
  id         String        @id @default(cuid())
  timestamp  DateTime      @default(now())
  userId     String?
  userEmail  String
  action     AuditAction
  resource   String
  resourceId String?
  details    String
  ipAddress  String?
  userAgent  String?
  status     String        @default("success")
  severity   AuditSeverity @default(INFO)
  metadata   Json?

  @@index([userId])
  @@index([userEmail])
  @@index([timestamp])
  @@index([action])
  @@index([resource])
  @@index([severity])
}

enum Role {
  STUDENT
  PARENT
  INSTRUCTOR
  SUPPORT
  ADMIN
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

enum Language {
  HTML
  CSS
  JAVASCRIPT
  PYTHON
  ROBLOX
  ENGINEERING
  AI_ML
  ROBOTICS
  WEB_DEVELOPMENT
  MOBILE_DEVELOPMENT
  GAME_DEVELOPMENT
  CAREER_PREP
}

enum AgeGroup {
  AGES_7_10
  AGES_11_14
  AGES_15_18
  AGES_18_PLUS
}

enum ThemePreference {
  LIGHT
  DARK
  COLORFUL
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum BookingType {
  ONE_ON_ONE
  GROUP
}

enum BookingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
  CONFIRMED
  ATTENDED
}

enum PaymentStatus {
  REQUIRES_PAYMENT
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}


enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  CODE_OUTPUT
}

enum SessionType {
  ONE_ON_ONE
  GROUP
  WORKSHOP
  CAMP
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RecurrencePattern {
  WEEKLY
  BIWEEKLY
  MONTHLY
}


enum MessageType {
  GENERAL
  PROGRESS_UPDATE
  CLASS_REMINDER
  FEEDBACK
}

enum BadgeCategory {
  ACHIEVEMENT
  STREAK
  SKILL
  SPECIAL
}

enum RequirementType {
  XP_TOTAL
  LESSONS_COMPLETED
  STREAK_DAYS
  COURSE_COMPLETED
  QUIZ_SCORE
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  TECHNICAL
  BILLING
  ACCOUNT
  COURSE_CONTENT
  BOOKING
  GENERAL
}

enum ClassRequestStatus {
  PENDING
  APPROVED
  REJECTED
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// =====================================================
// PROGRAM-BASED PAYMENT MODELS (replacing subscriptions)
// =====================================================

model Program {
  id                String              @id @default(cuid())
  title             String
  slug              String              @unique
  description       String
  shortDescription  String?
  thumbnailUrl      String?
  language          Language
  ageGroup          AgeGroup
  level             CourseLevel         @default(BEGINNER)
  sessionCount      Int                 // 6, 12, 18, 24 sessions
  sessionDuration   Int                 @default(60) // minutes per session
  priceCents        Int                 // one-time payment in cents
  originalPriceCents Int?               // for showing discounts
  features          Json?               // array of feature strings
  curriculum        Json?               // outline of what's covered
  startDate         DateTime?           // Program start date
  endDate           DateTime?           // Program end date
  isFeatured        Boolean             @default(false)
  isPublished       Boolean             @default(false)
  orderIndex        Int?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  enrollments       ProgramEnrollment[]
  courses           ProgramCourse[]     // courses included in this program
  classSessions     ClassSession[]      // scheduled class sessions for this program
}

model ProgramCourse {
  id        String  @id @default(cuid())
  programId String
  courseId  String
  orderIndex Int?
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([programId, courseId])
}

model ProgramEnrollment {
  id                    String                  @id @default(cuid())
  programId             String
  studentProfileId      String
  parentEmail           String
  status                ProgramEnrollmentStatus @default(ACTIVE)
  sessionsCompleted     Int                     @default(0)
  paidAmountCents       Int
  stripePaymentIntentId String?                 @unique
  paymentStatus         PaymentStatus           @default(PENDING)
  startDate             DateTime?
  completedAt           DateTime?
  notes                 String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  program               Program                 @relation(fields: [programId], references: [id])
  studentProfile        StudentProfile          @relation(fields: [studentProfileId], references: [id])

  @@index([parentEmail])
  @@index([studentProfileId])
  @@index([programId])
}

enum ProgramEnrollmentStatus {
  PENDING_PAYMENT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  REFUNDED
}

// =====================================================
// BLOG SYSTEM
// =====================================================

model BlogPost {
  id            String        @id @default(cuid())
  title         String
  slug          String        @unique
  excerpt       String?       // short description for cards
  content       String        // markdown or rich text content
  featuredImage String?
  authorEmail   String
  authorName    String?
  authorRole    Role          @default(ADMIN)
  category      BlogCategory  @default(NEWS)
  tags          Json?         // array of tag strings
  isPublished   Boolean       @default(false)
  isFeatured    Boolean       @default(false)
  viewCount     Int           @default(0)
  publishedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  comments      Comment[]
  likes         Like[]

  @@index([authorEmail])
  @@index([isPublished])
  @@index([category])
}

enum BlogCategory {
  NEWS
  TUTORIAL
  STUDENT_SPOTLIGHT
  PARENT_RESOURCES
  CODING_TIPS
  EVENTS
  ANNOUNCEMENTS
}

// =====================================================
// STUDENT PROJECT SHOWCASE
// =====================================================

model StudentProject {
  id              String               @id @default(cuid())
  studentProfileId String
  title           String
  description     String
  githubUrl       String?
  demoUrl         String?
  thumbnailUrl    String?
  videoUrl        String?
  language        Language?
  tags            Json?                // array of tag strings
  isPublished     Boolean              @default(false)
  isApproved      Boolean              @default(false) // admin approval for public display
  isFeatured      Boolean              @default(false)
  viewCount       Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  studentProfile  StudentProfile       @relation(fields: [studentProfileId], references: [id])
  comments        Comment[]
  likes           Like[]

  @@index([studentProfileId])
  @@index([isApproved])
  @@index([isFeatured])
}

// =====================================================
// SOCIAL FEATURES (Comments & Likes)
// =====================================================

model Comment {
  id               String          @id @default(cuid())
  content          String
  authorEmail      String
  authorName       String?
  authorRole       Role
  blogPostId       String?
  studentProjectId String?
  parentCommentId  String?         // for nested replies
  isApproved       Boolean         @default(true) // moderation
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  blogPost         BlogPost?       @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  studentProject   StudentProject? @relation(fields: [studentProjectId], references: [id], onDelete: Cascade)
  parentComment    Comment?        @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies          Comment[]       @relation("CommentReplies")
  likes            Like[]

  @@index([blogPostId])
  @@index([studentProjectId])
  @@index([authorEmail])
  @@index([parentCommentId])
}

model Like {
  id               String          @id @default(cuid())
  userEmail        String
  blogPostId       String?
  studentProjectId String?
  commentId        String?
  createdAt        DateTime        @default(now())
  blogPost         BlogPost?       @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  studentProject   StudentProject? @relation(fields: [studentProjectId], references: [id], onDelete: Cascade)
  comment          Comment?        @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userEmail, blogPostId])
  @@unique([userEmail, studentProjectId])
  @@unique([userEmail, commentId])
  @@index([userEmail])
}

// =====================================================
// FREE TRIAL SYSTEM
// =====================================================

model FreeTrialBooking {
  id                String            @id @default(cuid())
  parentEmail       String
  parentName        String?
  childName         String
  childAge          Int?
  ageGroup          AgeGroup?
  phone             String?

  // Session selection
  sessionId         String?           // Selected ClassSession for the trial
  programId         String?           // Which program they're interested in
  language          Language?         // Preferred coding language
  preferredDate     DateTime?
  preferredTime     String?
  timezone          String?           @default("America/New_York")

  // Status tracking
  status            FreeTrialStatus   @default(PENDING)
  scheduledAt       DateTime?         // Confirmed trial date/time
  completedAt       DateTime?
  convertedAt       DateTime?         // When they converted to paid

  // Follow-up
  reminderSent      Boolean           @default(false)
  followUpSent      Boolean           @default(false)
  feedback          String?
  rating            Int?              // 1-5 rating after trial
  conversionNotes   String?

  // Instructor assignment
  instructorEmail   String?
  instructorName    String?
  meetingUrl        String?

  // Conversion tracking
  convertedToProgramId String?        // Program they enrolled in after trial
  discountCodeUsed  String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([parentEmail, childName]) // One free trial per child per parent
  @@index([parentEmail])
  @@index([status])
  @@index([scheduledAt])
}

enum FreeTrialStatus {
  PENDING           // Just signed up, needs scheduling
  SCHEDULED         // Trial class is scheduled
  REMINDER_SENT     // 24hr reminder sent
  IN_PROGRESS       // Trial happening now
  COMPLETED         // Trial finished
  NO_SHOW           // Didn't attend
  CONVERTED         // Signed up for paid program
  DECLINED          // Decided not to continue
  EXPIRED           // Never scheduled within time limit
}

// =====================================================
// NEWSLETTER SUBSCRIBERS
// =====================================================

model NewsletterSubscriber {
  id            String    @id @default(cuid())
  email         String    @unique
  isActive      Boolean   @default(true)
  subscribedAt  DateTime  @default(now())
  unsubscribedAt DateTime?
  source        String?   // where they signed up (footer, blog, etc.)

  @@index([email])
  @@index([isActive])
}

// =====================================================
// ASSIGNMENT SYSTEM
// =====================================================

model Assignment {
  id                String                 @id @default(cuid())
  title             String
  description       String                 @db.Text
  instructions      String                 @db.Text
  type              AssignmentType         @default(CODING_PROJECT)
  language          Language?
  ageGroup          AgeGroup?
  dueDate           DateTime?
  maxPoints         Int                    @default(100)
  xpReward          Int                    @default(50)
  starterCode       String?                @db.Text
  solutionCode      String?                @db.Text
  rubric            Json?                  // grading criteria
  attachments       Json?                  // array of {name, url} objects
  isPublished       Boolean                @default(false)
  allowLateSubmission Boolean              @default(true)

  // Associations
  instructorId      String
  instructorEmail   String
  courseId          String?
  lessonId          String?
  programId         String?
  classSessionId    String?

  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  submissions       AssignmentSubmission[]

  @@index([instructorId])
  @@index([instructorEmail])
  @@index([courseId])
  @@index([programId])
  @@index([isPublished])
  @@index([dueDate])
}

model AssignmentSubmission {
  id                String                 @id @default(cuid())
  assignmentId      String
  studentId         String                 // User ID
  studentEmail      String
  studentName       String?

  // Submission content
  code              String?                @db.Text
  content           String?                @db.Text  // written response
  attachments       Json?                  // array of {name, url} objects
  repoUrl           String?                // GitHub repository link
  demoUrl           String?                // Live demo link

  // Status tracking
  status            SubmissionStatus       @default(DRAFT)
  submittedAt       DateTime?

  // Grading
  score             Int?
  feedback          String?                @db.Text
  rubricScores      Json?                  // individual rubric item scores
  gradedAt          DateTime?
  gradedByEmail     String?
  gradedByName      String?

  // Resubmission support
  attemptNumber     Int                    @default(1)
  previousSubmissionId String?

  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  assignment        Assignment             @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId, attemptNumber])
  @@index([assignmentId])
  @@index([studentId])
  @@index([studentEmail])
  @@index([status])
}

enum AssignmentType {
  CODING_PROJECT    // Write code from scratch
  CODE_REVIEW       // Review and improve existing code
  DEBUGGING         // Find and fix bugs
  QUIZ              // Multiple choice/short answer
  READING           // Read material and respond
  VIDEO             // Watch and respond
  CREATIVE          // Open-ended creative project
  CHALLENGE         // Timed coding challenge
}

enum SubmissionStatus {
  DRAFT             // Started but not submitted
  SUBMITTED         // Awaiting grading
  IN_REVIEW         // Instructor is reviewing
  GRADED            // Has been graded
  RETURNED          // Returned for revision
  RESUBMITTED       // Student resubmitted after feedback
  LATE              // Submitted after due date
}

// =====================================================
// RECEIVED EMAILS (Resend Inbound)
// =====================================================

model ReceivedEmail {
  id              String            @id @default(cuid())
  resendEmailId   String            @unique // Resend's email ID
  from            String            // Sender email address
  fromName        String?           // Sender display name
  to              String            // Recipient email (your domain)
  subject         String
  textBody        String?           @db.Text
  htmlBody        String?           @db.Text
  snippet         String?           // Preview text
  attachments     Json?             // Array of {filename, contentType, size, downloadUrl}

  // Processing status
  status          ReceivedEmailStatus @default(UNREAD)
  category        ReceivedEmailCategory @default(GENERAL)
  priority        TicketPriority    @default(MEDIUM)

  // Threading/conversation
  threadId        String?           // Group related emails
  parentEmailId   String?           // Reply-to email ID
  inReplyTo       String?           // Message-ID header for threading

  // Assignment
  assignedToEmail String?
  assignedToName  String?

  // Link to existing entities
  supportTicketId String?           // If converted to support ticket
  userId          String?           // If sender is a known user

  // Metadata
  receivedAt      DateTime          @default(now())
  processedAt     DateTime?
  archivedAt      DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  replies         EmailReply[]

  @@index([from])
  @@index([status])
  @@index([category])
  @@index([receivedAt])
  @@index([threadId])
}

model EmailReply {
  id              String          @id @default(cuid())
  receivedEmailId String
  fromEmail       String          // Staff member who replied
  fromName        String?
  toEmail         String          // Customer email
  subject         String
  htmlBody        String          @db.Text
  textBody        String?         @db.Text

  // Resend tracking
  resendMessageId String?         // ID from Resend after sending
  status          String          @default("sent") // sent, delivered, failed

  createdAt       DateTime        @default(now())

  receivedEmail   ReceivedEmail   @relation(fields: [receivedEmailId], references: [id], onDelete: Cascade)

  @@index([receivedEmailId])
  @@index([fromEmail])
}

enum ReceivedEmailStatus {
  UNREAD
  READ
  IN_PROGRESS
  REPLIED
  ARCHIVED
  SPAM
}

enum ReceivedEmailCategory {
  GENERAL
  SUPPORT
  BILLING
  ENROLLMENT
  FEEDBACK
  PARTNERSHIP
  SPAM
}

// =====================================================
// PARENT REVIEWS
// =====================================================

model ParentReview {
  id           String   @id @default(cuid())
  authorEmail  String
  authorName   String
  authorPhoto  String?  // URL to photo
  childName    String?  // Optional: "Parent of [child], age X"
  childAge     Int?
  rating       Int      @default(5) // 1-5 stars
  title        String?
  content      String   @db.Text
  isApproved   Boolean  @default(false) // Admin must approve
  isFeatured   Boolean  @default(false) // Show on homepage
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isApproved])
  @@index([isFeatured])
  @@index([authorEmail])
}
